version: "3.8"

services:
  kafka1:
    image: apache/kafka:3.7.0
    hostname: kafka1
    volumes:
      - kafka1-log:/var/lib/kafka/data
    secrets:
      - kafka-truststore
      - kafka1-keystore
    networks:
      kafka-client-network:
        ipv4_address: 192.168.45.10
        aliases: [ "kafka1" ]
      kafka-inter-node-network:
        ipv4_address: 192.168.55.10
    ports:
      - "9093:9093"
    env_file:
      - ./kafka1.env

  kafka2:
    image: apache/kafka:3.7.0
    hostname: kafka2
    volumes:
      - kafka2-log:/var/lib/kafka/data
    secrets:
      - kafka-truststore
      - kafka2-keystore
    networks:
      kafka-client-network:
        ipv4_address: 192.168.45.20
        aliases: [ "kafka2" ]
      kafka-inter-node-network:
        ipv4_address: 192.168.55.20
    ports:
      - "9094:9094"
    env_file:
      - ./kafka2.env

  initializer:
    build:
      context: ..  # The root of the domainradar repo
      dockerfile: ./pipeline-all-in-one/initializer.Dockerfile
    depends_on:
      - kafka1
      - kafka2
    secrets:
      - kafka-truststore
      - client1-keystore
    networks:
      - kafka-client-network
    volumes:
      - ./client_properties/initializer.properties:/scripts/client.properties
    environment:
      - BOOTSTRAP=kafka1:9093,kafka2:9094
      - COMMAND_CONFIG_FILE=/scripts/client.properties

  collector-zone:
    image: domrad-java-standalone:latest
    command: [ "--col-zone", "-id", "${ID_PREFIX-domrad}", "-p", "/app/client.properties", "-s", "kafka1:9093,kafka2:9094" ]
    depends_on:
      initializer:
        condition: service_completed_successfully
    secrets:
      - kafka-truststore
      - client2-keystore
    networks:
      - kafka-client-network
      - collector-network
    volumes:
      - ./client_properties/zone.properties:/app/client.properties
    
  collector-dns:
    image: domrad-java-standalone:latest
    command: [ "--col-dns", "-id", "${ID_PREFIX-domrad}", "-p", "/app/client.properties", "-s", "kafka1:9093,kafka2:9094" ]
    depends_on:
      initializer:
        condition: service_completed_successfully
    secrets:
      - kafka-truststore
      - client2-keystore
    networks:
      - kafka-client-network
      - collector-network
    volumes:
      - ./client_properties/dns.properties:/app/client.properties

  collector-nerd:
    image: domrad-java-standalone:latest
    command: [ "--col-nerd", "-id", "${ID_PREFIX-domrad}", "-p", "/app/client.properties", "-s", "kafka1:9093,kafka2:9094" ]
    depends_on:
      initializer:
        condition: service_completed_successfully
    secrets:
      - kafka-truststore
      - client2-keystore
    networks:
      - kafka-client-network
      - collector-network
    volumes:
      - ./client_properties/nerd.properties:/app/client.properties

  collector-geoip:
    image: domrad-java-streams:latest
    command: [ "--col-geoip", "-t", "${THREADS:-4}", "-id", "${ID_PREFIX-domrad}-geoip", "-p", "/app/client.properties", "-s", "kafka1:9093,kafka2:9094" ]
    depends_on:
      initializer:
        condition: service_completed_successfully
    secrets:
      - kafka-truststore
      - client2-keystore
    networks:
      - kafka-client-network
      - collector-network
    volumes:
      - ./client_properties/geoip.properties:/app/client.properties
      - ./geoip_data/:/app/geoip/
    #entrypoint: /bin/bash
    #stdin_open: true
    #tty: true

  merger-ip:
    image: domrad-java-streams:latest
    command: [ "--ip-merger", "-t", "${THREADS:-4}", "-id", "${ID_PREFIX-domrad}-merger-ip", "-p", "/app/client.properties", "-s", "kafka1:9093,kafka2:9094" ]
    depends_on:
      initializer:
        condition: service_completed_successfully
    secrets:
      - kafka-truststore
      - client2-keystore
    networks:
      - kafka-client-network
      - collector-network
    volumes:
      - ./client_properties/mergers.properties:/app/client.properties

  merger-all:
    image: domrad-java-streams:latest
    command: [ "--domain-merger", "-t", "${THREADS:-4}", "-id", "${ID_PREFIX-domrad}-merger-all", "-p", "/app/client.properties", "-s", "kafka1:9093,kafka2:9094" ]
    depends_on:
      initializer:
        condition: service_completed_successfully
    secrets:
      - kafka-truststore
      - client2-keystore
    networks:
      - kafka-client-network
      - collector-network
    volumes:
      - ./client_properties/mergers.properties:/app/client.properties

volumes:
  kafka1-log:
  kafka2-log:

networks:
  kafka-client-network:
    driver: bridge
    enable_ipv6: false
    ipam:
      driver: default
      config:
        - subnet: 192.168.45.0/24
          ip_range: 192.168.45.0/24
  kafka-inter-node-network:
    driver: bridge
    enable_ipv6: false
    ipam:
      driver: default
      config:
        - subnet: 192.168.55.0/24
          ip_range: 192.168.55.0/24
  collector-network:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: fd10:3456:789a:1::/64

secrets:
  kafka-truststore:
    file: ./secrets/kafka.truststore.jks
  kafka1-keystore:
    file: ./secrets/secrets_kafka1/kafka1.keystore.jks
  kafka2-keystore:
    file: ./secrets/secrets_kafka2/kafka2.keystore.jks
  client1-keystore:
    file: ./secrets/secrets_client1/client1.keystore.jks
  client2-keystore:
    file: ./secrets/secrets_client2/client2.keystore.jks
    